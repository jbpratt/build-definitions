---
- op: replace
  path: /metadata/name
  value: dynamic-operator-catalog-build
- op: add
  path: /spec/description
  value: |
    This pipeline is used to generated an OLM catalog based on the provided
    bundle images and version. The catalog is generated by initalizing a new
    package config blob then rendering the provided OLM bundle image into a
    single entry channel.

# Remove unused params from template
# $ kustomize build ./pipelines/fbc-builder/ | yq '.spec.params.[].name' | nl -v 0
#      0	git-url
#      1	revision
#      2	output-image
#      3	path-context
#      4	dockerfile
#      5	rebuild
#      6	skip-checks
#      7	hermetic
#      8	prefetch-input
#      9	image-expires-after
#     10	build-source-image
#     11	build-image-index
- op: remove
  path: /spec/params/11  # build-image-index
- op: remove
  path: /spec/params/10  # build-source-image
- op: remove
  path: /spec/params/8  # prefetch-input
- op: remove
  path: /spec/params/6  # skip-checks
- op: remove
  path: /spec/params/4 # dockerfile (set below directly to the generated path)
- op: remove
  path: /spec/params/3 # path-context (set below directly)
- op: remove
  path: /spec/tasks/0/params/2  # remove the skip-checks param

# Add additional params
- op: add
  path: /spec/params/-
  value:
    name: operator-name
    description: "The operator or package name"
    type: string
    default: ""
- op: add
  path: /spec/params/-
  value:
    name: operator-bundle-image
    description: "The latest operator bundle image to be rendered into the catalog"
    type: string
    default: ""
- op: add
  path: /spec/params/-
  value:
    name: default-channel
    description: "The channel name that OLM subscriptions will default"
    type: string
    default: "stable"

# Rearrange tasks - inject dynamic generation tasks, shift build-container down
# $ kustomize build ./pipelines/fbc-builder/ | yq '.spec.tasks.[].name' | nl -v 0
#      0	init
#      1	clone-repository
#      2	build-container
#      3	build-image-index
#      4	deprecated-base-image-check
#      5	apply-tags
#      6	inspect-image
#      7	fbc-validate
#      8	fbc-related-image-check
- op: replace
  path: /spec/tasks/2
  value:
    name: opm-get-bundle-version
    runAfter:
      - clone-repository
    taskRef:
      name: opm-get-bundle-version
      version: "0.1"
    params:
    - name: bundle-image
      value: $(params.operator-bundle-image)
    workspaces:
    - name: workspace
      workspace: workspace
- op: replace
  path: /spec/tasks/3
  value:
    name: opm-render-bundles
    runAfter:
      - opm-get-bundle-version
    taskRef:
      name: opm-render-bundles
      version: "0.1"
    params:
    - name: bundle-images
      value: $(params.operator-bundle-image)
    - name: operator-name
      value: $(params.operator-name)
    - name: operator-version
      value: v$(tasks.opm-get-bundle-version.results.bundle-version)
    - name: default-channel
      value: $(params.default-channel)
    workspaces:
    - name: source
      workspace: workspace
- op: replace
  path: /spec/tasks/4
  value:
    name: build-container
    runAfter:
      - opm-render-bundles
    taskRef:
      name: buildah
      version: "0.2"
    params:
    - name: IMAGE
      value: $(params.output-image)
    - name: DOCKERFILE
      value: catalog.Dockerfile
    - name: CONTEXT
      value: .
    - name: HERMETIC
      value: "$(params.hermetic)"
    - name: IMAGE_EXPIRES_AFTER
      value: "$(params.image-expires-after)"
    - name: COMMIT_SHA
      value: "$(tasks.clone-repository.results.commit)"
    workspaces:
    - name: source
      workspace: workspace

# Remove unused workspaces
- op: remove
  path: /spec/workspaces/2  # netrc (only used for prefetch-dependencies)

# Replace runAfter for subsequent tasks
- op: replace
  path: /spec/tasks/8/runAfter/0 # fbc-related-image-check
  value: build-container
- op: replace
  path: /spec/tasks/7/runAfter/0 # fbc-validate
  value: build-container
- op: replace
  path: /spec/tasks/6/runAfter/0 # inspect-image
  value: build-container
- op: replace
  path: /spec/tasks/5/runAfter/0 # apply-tags
  value: build-container
